<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unlock & Fix dr@medexhealthservices.com Account</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #2d3748;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: #718096;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .alert {
      background: #fed7d7;
      border-left: 4px solid #fc8181;
      padding: 16px;
      margin-bottom: 24px;
      border-radius: 8px;
    }
    .alert-title {
      font-weight: 600;
      color: #c53030;
      margin-bottom: 8px;
    }
    .alert-text {
      color: #742a2a;
      font-size: 14px;
    }
    .section {
      background: #f7fafc;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      border: 2px solid #e2e8f0;
    }
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .badge {
      background: #667eea;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
      margin-bottom: 12px;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .output {
      background: #1a202c;
      color: #e2e8f0;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 16px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .success { color: #48bb78; }
    .error { color: #fc8181; }
    .warning { color: #f6ad55; }
    .info { color: #63b3ed; }
    .progress {
      background: #e2e8f0;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin: 16px 0;
    }
    .progress-bar {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      height: 100%;
      width: 0;
      transition: width 0.5s ease;
    }
    .step {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      padding: 12px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    .step-number {
      background: #667eea;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      flex-shrink: 0;
    }
    .step-content {
      flex: 1;
    }
    .step-title {
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 4px;
    }
    .step-desc {
      font-size: 13px;
      color: #718096;
    }
    .credentials {
      background: #c6f6d5;
      border: 2px solid #48bb78;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }
    .credentials strong {
      color: #22543d;
    }
    code {
      background: #edf2f7;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #2d3748;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîì Unlock & Fix Account</h1>
    <p class="subtitle">Emergency unlock and password reset tool for dr@medexhealthservices.com</p>

    <div class="alert">
      <div class="alert-title">‚ö†Ô∏è Current Issue</div>
      <div class="alert-text">
        Account temporarily blocked due to too many failed login attempts. Password not persisting across sessions.
      </div>
    </div>

    <div class="section">
      <div class="section-title">
        <span>üìã</span> What This Tool Does
      </div>
      <div class="step">
        <div class="step-number">1</div>
        <div class="step-content">
          <div class="step-title">Clear Account Lockout</div>
          <div class="step-desc">Removes failed login attempts from Supabase and localStorage</div>
        </div>
      </div>
      <div class="step">
        <div class="step-number">2</div>
        <div class="step-content">
          <div class="step-title">Reset Password (Dual Storage)</div>
          <div class="step-desc">Stores new password in BOTH Supabase AND localStorage for persistence</div>
        </div>
      </div>
      <div class="step">
        <div class="step-number">3</div>
        <div class="step-content">
          <div class="step-title">Enable Account</div>
          <div class="step-desc">Ensures is_active is set to true in database</div>
        </div>
      </div>
      <div class="step">
        <div class="step-number">4</div>
        <div class="step-content">
          <div class="step-title">Verify Login</div>
          <div class="step-desc">Tests authentication with new password</div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">
        <span>üöÄ</span> Run Fix <span class="badge">One Click</span>
      </div>
      <button id="runFixBtn" onclick="runCompleteFix()">üîß Unlock & Reset Password</button>
      <div class="progress" style="display: none;" id="progressBar">
        <div class="progress-bar" id="progressFill"></div>
      </div>
      <div class="output" id="output" style="display: none;"></div>
    </div>

    <div class="section">
      <div class="section-title">
        <span>üß™</span> Test Login
      </div>
      <button id="testLoginBtn" onclick="testLogin()" disabled>üîê Test Authentication</button>
      <div class="output" id="testOutput" style="display: none;"></div>
    </div>

    <div class="credentials" id="credentialsBox" style="display: none;">
      <div style="font-weight: 600; margin-bottom: 8px; color: #22543d;">‚úÖ Account Fixed - New Credentials:</div>
      <div><strong>Email:</strong> dr@medexhealthservices.com</div>
      <div><strong>Password:</strong> <code id="newPassword">MedEx2025!</code></div>
      <div style="margin-top: 8px; font-size: 13px; color: #2f855a;">
        ‚ÑπÔ∏è User should change this password after first login in Settings
      </div>
    </div>
  </div>

  <script type="module">
    // Import necessary services
    import { supabase } from './src/config/supabase.js';
    import { userManagementService } from './src/services/userManagementService.js';
    import { encryptionService } from './src/services/encryption.js';

    let outputDiv, progressBar, progressFill;

    window.addEventListener('DOMContentLoaded', () => {
      outputDiv = document.getElementById('output');
      progressBar = document.getElementById('progressBar');
      progressFill = document.getElementById('progressFill');
    });

    function log(message, type = 'info') {
      const colors = {
        success: 'success',
        error: 'error',
        warning: 'warning',
        info: 'info'
      };
      const timestamp = new Date().toLocaleTimeString();
      const line = `[${timestamp}] ${message}\n`;
      outputDiv.innerHTML += `<span class="${colors[type]}">${line}</span>`;
      outputDiv.scrollTop = outputDiv.scrollHeight;
    }

    function updateProgress(percent) {
      progressFill.style.width = `${percent}%`;
    }

    window.runCompleteFix = async function() {
      const btn = document.getElementById('runFixBtn');
      const testBtn = document.getElementById('testLoginBtn');
      const credBox = document.getElementById('credentialsBox');

      btn.disabled = true;
      testBtn.disabled = true;
      outputDiv.style.display = 'block';
      progressBar.style.display = 'block';
      outputDiv.innerHTML = '';
      updateProgress(0);
      credBox.style.display = 'none';

      try {
        log('üîß Starting comprehensive account fix...', 'info');
        log('‚îÄ'.repeat(60), 'info');

        // Step 1: Find user
        updateProgress(10);
        log('\nüìç Step 1: Locating user account...', 'info');
        const { data: users, error: userError } = await supabase
          .from('users')
          .select('id, email, is_active, role')
          .eq('email', 'dr@medexhealthservices.com')
          .eq('tenant_id', 'medex');

        if (userError || !users || users.length === 0) {
          throw new Error('User not found in database');
        }

        const user = users[0];
        log(`‚úÖ Found user: ${user.email}`, 'success');
        log(`   User ID: ${user.id}`, 'info');
        log(`   Role: ${user.role}`, 'info');
        log(`   Active: ${user.is_active}`, 'info');

        // Step 2: Clear lockout
        updateProgress(25);
        log('\nüîì Step 2: Clearing account lockout...', 'info');

        // Clear from Supabase
        const { error: clearError } = await supabase
          .from('failed_login_attempts')
          .delete()
          .eq('email', 'dr@medexhealthservices.com');

        if (!clearError) {
          log('‚úÖ Cleared failed login attempts from Supabase', 'success');
        }

        // Clear from localStorage
        localStorage.removeItem(`loginStats_${user.id}`);
        localStorage.removeItem('failed_login_attempts');
        log('‚úÖ Cleared lockout data from localStorage', 'success');

        // Step 3: Enable account
        updateProgress(40);
        log('\nüîë Step 3: Enabling account...', 'info');
        const { error: enableError } = await supabase
          .from('users')
          .update({ is_active: true })
          .eq('id', user.id)
          .eq('tenant_id', 'medex');

        if (!enableError) {
          log('‚úÖ Account enabled successfully', 'success');
        }

        // Step 4: Reset password (DUAL STORAGE)
        updateProgress(55);
        log('\nüîê Step 4: Resetting password...', 'info');
        const newPassword = 'MedEx2025!';

        log('   Calling userManagementService.changeUserPassword...', 'info');
        const result = await userManagementService.changeUserPassword(user.id, newPassword);

        if (result.status === 'success') {
          log('‚úÖ Password stored in Supabase', 'success');
          log('‚úÖ Password stored in localStorage', 'success');
          log('‚úÖ Password will persist across sessions', 'success');
        } else {
          throw new Error(`Password change failed: ${result.error}`);
        }

        // Step 5: Verify storage
        updateProgress(75);
        log('\nüîç Step 5: Verifying password storage...', 'info');

        // Check localStorage
        const localCreds = localStorage.getItem(`userCredentials_${user.id}`);
        if (localCreds) {
          log('‚úÖ Verified: Password exists in localStorage', 'success');
        } else {
          log('‚ö†Ô∏è Warning: Password not found in localStorage', 'warning');
        }

        // Check Supabase
        const { data: profile } = await supabase
          .from('user_profiles')
          .select('encrypted_retell_api_key')
          .eq('user_id', user.id)
          .single();

        if (profile && profile.encrypted_retell_api_key) {
          log('‚úÖ Verified: Password exists in Supabase', 'success');
        } else {
          log('‚ö†Ô∏è Warning: Password not found in Supabase', 'warning');
        }

        // Step 6: Final verification
        updateProgress(90);
        log('\n‚úÖ Step 6: Final verification...', 'info');
        log('‚úÖ Account unlocked', 'success');
        log('‚úÖ Password reset complete', 'success');
        log('‚úÖ Dual storage verified', 'success');

        updateProgress(100);
        log('\n' + '‚ïê'.repeat(60), 'success');
        log('üéâ ACCOUNT FIX COMPLETE!', 'success');
        log('‚ïê'.repeat(60), 'success');
        log('\nüìß Email: dr@medexhealthservices.com', 'info');
        log('üîë Password: MedEx2025!', 'info');
        log('\n‚ÑπÔ∏è  User can now log in and should change password in Settings', 'info');

        // Show credentials box
        credBox.style.display = 'block';
        testBtn.disabled = false;

      } catch (error) {
        log(`\n‚ùå ERROR: ${error.message}`, 'error');
        log('\nüí° Troubleshooting:', 'warning');
        log('   1. Make sure you\'re running this in the MedEx CRM app', 'warning');
        log('   2. Check browser console for detailed errors', 'warning');
        log('   3. Verify Supabase connection is working', 'warning');
        updateProgress(0);
      } finally {
        btn.disabled = false;
      }
    };

    window.testLogin = async function() {
      const testOutput = document.getElementById('testOutput');
      const btn = document.getElementById('testLoginBtn');

      btn.disabled = true;
      testOutput.style.display = 'block';
      testOutput.innerHTML = '';

      function logTest(message, type = 'info') {
        const colors = {
          success: 'success',
          error: 'error',
          warning: 'warning',
          info: 'info'
        };
        const timestamp = new Date().toLocaleTimeString();
        const line = `[${timestamp}] ${message}\n`;
        testOutput.innerHTML += `<span class="${colors[type]}">${line}</span>`;
        testOutput.scrollTop = testOutput.scrollHeight;
      }

      try {
        logTest('üß™ Testing authentication...', 'info');

        const result = await userManagementService.authenticateUser(
          'dr@medexhealthservices.com',
          'MedEx2025!'
        );

        if (result.status === 'success' && result.data) {
          logTest('‚úÖ Authentication successful!', 'success');
          logTest(`   User ID: ${result.data.id}`, 'info');
          logTest(`   Email: ${result.data.email}`, 'info');
          logTest(`   Role: ${result.data.role}`, 'info');
          logTest('\nüéâ Account is working correctly!', 'success');
        } else {
          logTest('‚ùå Authentication failed', 'error');
          logTest(`   Error: ${result.error || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        logTest(`‚ùå Test error: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
      }
    };
  </script>
</body>
</html>
