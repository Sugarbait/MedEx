<!DOCTYPE html>
<html>
<head>
  <title>Check test2@test.com Credentials</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      margin-top: 10px;
    }
    button:hover {
      background: #2563eb;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      background: #f3f4f6;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      max-height: 500px;
      overflow-y: auto;
    }
    .success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #10b981;
    }
    .error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #ef4444;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Check test2@test.com Credentials</h1>
    <p>This will check the stored credentials and Supabase Auth status for test2@test.com</p>

    <button onclick="checkCredentials()">Check Credentials</button>
    <button onclick="testSupabaseAuth()">Test Supabase Auth Login</button>
    <button onclick="fixCredentials()">Reset Credentials to test1000!</button>

    <div id="result" class="result"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

    const SUPABASE_URL = 'https://cpkslvmydfdevdftieck.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwa3Nsdm15ZGZkZXZkZnRpZWNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY5MDAyOTUsImV4cCI6MjA2MjQ3NjI5NX0.Y_Q3trteZof2o-tH_hqYdLa7SvkDy0cHN90qtF5bSDk'
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    window.supabase = supabase

    window.checkCredentials = async function() {
      const resultDiv = document.getElementById('result')
      resultDiv.className = 'result'
      resultDiv.innerHTML = '‚è≥ Checking credentials...\n\n'

      const logs = []

      try {
        // Step 1: Check if user exists in Supabase
        logs.push('1Ô∏è‚É£ Checking Supabase users table...')
        const { data: users, error: userError } = await supabase
          .from('users')
          .select('*')
          .eq('email', 'test2@test.com')
          .eq('tenant_id', 'medex')

        if (userError) {
          logs.push(`   ‚ùå Error: ${userError.message}`)
        } else if (!users || users.length === 0) {
          logs.push('   ‚ö†Ô∏è User not found in Supabase users table')
        } else {
          const user = users[0]
          logs.push(`   ‚úÖ User found in Supabase`)
          logs.push(`   User ID: ${user.id}`)
          logs.push(`   Name: ${user.name}`)
          logs.push(`   Email: ${user.email}`)
          logs.push(`   Role: ${user.role}`)
          logs.push(`   isActive: ${user.isActive}`)
          logs.push(`   is_locked: ${user.is_locked}`)
          logs.push(`   failed_login_attempts: ${user.failed_login_attempts}`)

          // Step 2: Check user_profiles for encrypted credentials
          logs.push('\n2Ô∏è‚É£ Checking user_profiles for encrypted credentials...')
          const { data: profiles, error: profileError } = await supabase
            .from('user_profiles')
            .select('encrypted_retell_api_key')
            .eq('user_id', user.id)

          if (profileError) {
            logs.push(`   ‚ö†Ô∏è Error: ${profileError.message}`)
          } else if (!profiles || profiles.length === 0) {
            logs.push('   ‚ö†Ô∏è No user_profiles entry found')
          } else {
            const hasCredentials = profiles[0].encrypted_retell_api_key ? 'Yes' : 'No'
            logs.push(`   Encrypted credentials stored: ${hasCredentials}`)
            if (profiles[0].encrypted_retell_api_key) {
              logs.push(`   Encrypted data length: ${profiles[0].encrypted_retell_api_key.length} characters`)
            }
          }

          // Step 3: Check localStorage
          logs.push('\n3Ô∏è‚É£ Checking localStorage...')
          const credsKey = `credentials_${user.id}`
          const storedCreds = localStorage.getItem(credsKey)
          if (storedCreds) {
            logs.push(`   ‚úÖ localStorage credentials found (${storedCreds.length} characters)`)
          } else {
            logs.push('   ‚ö†Ô∏è No localStorage credentials found')
          }

          // Step 4: Check failed login attempts
          logs.push('\n4Ô∏è‚É£ Checking failed login attempts...')
          const { data: attempts, error: attemptsError } = await supabase
            .from('failed_login_attempts')
            .select('*')
            .eq('email', 'test2@test.com')
            .order('attempted_at', { ascending: false })
            .limit(5)

          if (attemptsError) {
            logs.push(`   ‚ö†Ô∏è Error: ${attemptsError.message}`)
          } else if (!attempts || attempts.length === 0) {
            logs.push('   ‚úÖ No failed login attempts')
          } else {
            logs.push(`   ‚ö†Ô∏è Found ${attempts.length} recent failed attempts:`)
            attempts.forEach((attempt, i) => {
              logs.push(`   ${i+1}. ${new Date(attempt.attempted_at).toLocaleString()} - ${attempt.failure_reason}`)
            })
          }
        }

        resultDiv.innerHTML = logs.join('\n')

      } catch (error) {
        resultDiv.className = 'result error'
        resultDiv.innerHTML = `‚ùå Error:\n${error.message}\n\n${logs.join('\n')}`
      }
    }

    window.testSupabaseAuth = async function() {
      const resultDiv = document.getElementById('result')
      resultDiv.className = 'result'
      resultDiv.innerHTML = '‚è≥ Testing Supabase Auth login with test1000!...\n\n'

      const logs = []

      try {
        logs.push('Attempting to sign in with email: test2@test.com and password: test1000!')

        const { data, error } = await supabase.auth.signInWithPassword({
          email: 'test2@test.com',
          password: 'test1000!'
        })

        if (error) {
          logs.push(`\n‚ùå Supabase Auth login failed!`)
          logs.push(`Error: ${error.message}`)
          logs.push(`\nThis means the Supabase Auth user either:`)
          logs.push(`1. Was not created successfully`)
          logs.push(`2. Was created with a different password`)
          logs.push(`3. Has been locked or disabled`)
        } else if (data?.session) {
          logs.push(`\n‚úÖ Supabase Auth login successful!`)
          logs.push(`Session created: ${data.session.access_token.substring(0, 20)}...`)
          logs.push(`User ID: ${data.user?.id}`)

          // Sign out immediately
          await supabase.auth.signOut()
          logs.push(`\n‚úÖ Signed out successfully`)
        } else {
          logs.push(`\n‚ö†Ô∏è Unexpected response - no error but no session either`)
        }

        resultDiv.innerHTML = logs.join('\n')

      } catch (error) {
        resultDiv.className = 'result error'
        resultDiv.innerHTML = `‚ùå Error:\n${error.message}\n\n${logs.join('\n')}`
      }
    }

    window.fixCredentials = async function() {
      const resultDiv = document.getElementById('result')
      resultDiv.className = 'result'
      resultDiv.innerHTML = '‚è≥ Resetting credentials to test1000!...\n\n'

      const logs = []

      try {
        // Step 1: Get user from Supabase
        logs.push('1Ô∏è‚É£ Finding user in Supabase...')
        const { data: users, error: userError } = await supabase
          .from('users')
          .select('id, email')
          .eq('email', 'test2@test.com')
          .eq('tenant_id', 'medex')

        if (userError || !users || users.length === 0) {
          throw new Error('User not found in Supabase')
        }

        const user = users[0]
        logs.push(`   ‚úÖ User found: ${user.id}`)

        // Step 2: Update Supabase Auth password (requires admin API)
        logs.push('\n2Ô∏è‚É£ NOTE: Supabase Auth password reset requires admin API key')
        logs.push('   ‚ö†Ô∏è This can only be done from the backend/admin panel')
        logs.push('   You may need to use Supabase dashboard to reset the password')

        // Step 3: Clear all lockouts
        logs.push('\n3Ô∏è‚É£ Clearing lockouts...')

        // Clear users table lockout
        const { error: updateError } = await supabase
          .from('users')
          .update({
            is_locked: false,
            failed_login_attempts: 0,
            last_failed_login: null,
            locked_at: null,
            locked_reason: null
          })
          .eq('id', user.id)

        if (!updateError) {
          logs.push('   ‚úÖ Cleared users table lockout')
        }

        // Clear failed attempts
        const { error: deleteError } = await supabase
          .from('failed_login_attempts')
          .delete()
          .eq('email', 'test2@test.com')

        if (!deleteError) {
          logs.push('   ‚úÖ Cleared failed login attempts')
        }

        // Clear localStorage
        const loginStatsKey = `loginStats_${user.id}`
        localStorage.removeItem(loginStatsKey)
        logs.push('   ‚úÖ Cleared localStorage lockout')

        logs.push('\n‚úÖ Lockout cleared!')
        logs.push('\nüìù NEXT STEPS:')
        logs.push('1. Go to Supabase dashboard ‚Üí Authentication ‚Üí Users')
        logs.push('2. Find test2@test.com')
        logs.push('3. Reset password to: test1000!')
        logs.push('4. OR delete the user and recreate it from User Management')

        resultDiv.innerHTML = logs.join('\n')

      } catch (error) {
        resultDiv.className = 'result error'
        resultDiv.innerHTML = `‚ùå Error:\n${error.message}\n\n${logs.join('\n')}`
      }
    }
  </script>
</body>
</html>
